#!/usr/bin/env php
<?php

require __DIR__.'/../vendor/autoload.php';

class Hosts extends Illuminate\Console\Command
{
    protected $signature = 'hosts
        {source* : Support: google, apple}
        {--operator=ChinaNet : Support: ChinaNet, ChinaUnicom, CMCC}';

    protected $description = 'Get the latest hosts';

    public function handle()
    {
        $hosts = '';

        foreach ($this->argument('source') as $source) {
            if ($source == 'google') {
                $hosts .= $this->getGoogleHosts();
            } elseif ($source == 'apple') {
                $hosts .= $this->getAppleHosts($this->option('operator'));
            }
        }

        $this->info($hosts);
    }

    protected function getGoogleHosts()
    {
        return file_get_contents('https://raw.githubusercontent.com/racaljk/hosts/master/hosts');
    }

    protected function getAppleHosts($operator = 'ChinaNet')
    {
        $cwd = getcwd();

        $dir = sys_get_temp_dir().'/'.uniqid('AppleDNS-', true);
        $repo = 'https://github.com/gongjianhui/AppleDNS.git';

        exec("git clone $repo --single-branch --depth=1 -q \"$dir\"");
        chdir($dir);

        $file = $operator.'.json';
        if (! file_exists($file)) {
            $this->error($file.' does not exist');

            chdir($cwd);
            return '';
        }

        exec("python fetch-timeout.py $file");

        $hosts = shell_exec('python export-configure.py hosts');

        chdir($cwd);
        return $hosts;
    }
}

(new ElfSundae\Console\Application('Hosts', '1.0.0'))
    ->add(new Hosts)
    ->getApplication()
    ->runAsSingle();

#!/bin/sh

# 对ipa文件重签名
#elfcodesign "/path/to/ipafile.ipa"


echo "\033[0;31mElfCodeSigner v1.1.0  © 2015 www.0x123.com\033[0m\n"

if [ "$#" -ne 1 ]; then
        this=$(basename "$0")
        echo "Usage: $this \"ipa file\"" >&2
        exit 1
fi


exit
if ! [ -f "$1" ]; then
        echo "\"$1\" ipa file is not found" >&2
        exit 1
fi


IPA_FILE=$1
IPA_DIR=$(dirname "$1")
IPA_FILENAME=$(basename "${IPA_FILE%.*}")
RESIGN_PROVISION="$(dirname "$0")/InHouse.mobileprovision";
RESIGN_RESOURCERULES="$(dirname "$0")/ResourceRules.plist";
RESIGN_CERT="iPhone Distribution: Lefeng Technology Limited Company";
NEW_IPA_FILENAME="${IPA_FILENAME}-$(date +%s)"
TMP_DIR="${IPA_DIR}/${NEW_IPA_FILENAME}"

# 检查文件
if ! [ -f "$RESIGN_PROVISION" ]; then
        echo "\"$RESIGN_PROVISION\" ipa file is not found" >&2
        exit 1
fi
if ! [ -f "$RESIGN_RESOURCERULES" ]; then
        echo "\"$RESIGN_RESOURCERULES\" ipa file is not found" >&2
        exit 1
fi
if ! [ -f "/usr/bin/codesign" ]; then
        echo "\"/usr/bin/codesign\" ipa file is not found" >&2
        exit 1
fi


# 解压ipa
unzip -q "${IPA_FILE}" -d "${TMP_DIR}"

NEW_APP_DIR=$(find "${TMP_DIR}" -type d -name *.app)
if ! [ -d "$NEW_APP_DIR" ]; then
        echo "App bundle was not found."
        exit 1
fi
if ! [ -d "${TMP_DIR}/Payload" ]; then
        echo "It is not a iOS App."
        exit 1
fi

# 删除原来的签名和描述文件
rm -r "${NEW_APP_DIR}/_CodeSignature"
rm -rf "${NEW_APP_DIR}/embedded.mobileprovision"

# 拷贝新的描述文件
cp "${RESIGN_PROVISION}" "${NEW_APP_DIR}/embedded.mobileprovision"

# 修改bundleID
/usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.0x123.inhouse" "${NEW_APP_DIR}/Info.plist"

# 重签名
# 改变工作目录，让codesign显示的信息中不带ipa目录，只显示xxx.app
APP_NAME=$(basename "$NEW_APP_DIR")
cd "${TMP_DIR}/Payload"
/usr/bin/codesign -f -s "${RESIGN_CERT}" --resource-rules "${RESIGN_RESOURCERULES}" "${APP_NAME}"
# 验证
/usr/bin/codesign -v --no-strict "${APP_NAME}"
cd $(dirname "$0")

# 压缩回ipa
cd "$TMP_DIR"
NEW_IPA_FILE="${NEW_IPA_FILENAME}.ipa"
zip -qr "${NEW_IPA_FILE}" "Payload"
mv "${NEW_IPA_FILE}" ..
cd $(dirname "$0")

echo "Output: ""${IPA_DIR}/${NEW_IPA_FILE}"

# 删除临时目录
rm -r "$TMP_DIR"

exit

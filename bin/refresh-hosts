#!/bin/sh

HOSTS=""

# function to display commands
# http://stackoverflow.com/a/23342259/521946
exe() { echo '$' "${@:q}" ; "$@" ; }

usage() {
    echo "Avariable Arguments: google apple"
    exit
}

if [ "$#" -ne 1 ]; then
    usage
fi

for arg in "$@"; do
    if [[ $arg == "-h" || $arg == "--help" ]]; then
        usage
    fi
done

#####################################################################################
# Google hosts
######################################################################################

for arg in "$@"; do
    if [[ $arg == "google" ]]; then
        exe cd "/data/projects/github/hosts"

        exe git pull

        HOSTS+=$(cat hosts)"\n"
    fi
done

#####################################################################################
# AppleDNS
######################################################################################

for arg in "$@"; do
    if [[ $arg == "apple" ]]; then

        # 切到 AppleDNS 的文件夹
        exe cd "/data/projects/github/AppleDNS"

        exe git pull

        # Python 2.7+ / Python 3.4+ 兼容脚本
        #（请选择你的运营商对应文件 ChinaUnicom 联通、 ChinaNet 电信、 CMCC 移动）
        # 确认即开始进行测速，需等待数秒

        echo ">> Fetching Apple DNS..."
        exe python fetch-timeout.py ChinaNet.json >> /dev/null 2>&1

        # 生成各种形式的配置(如 Surge 执行 python export-configure.py surge)

        # ** 将配置文件放到相应的位置（HOSTS 放入系统相应位置、路由器用户请独立配置路由器后台）**
        # ** Surge 用户请在配置文件 [Rule] 前新建 [Host] 将生成的配置放入 [Host] 后（[Rule] 前）。**
        #
        # python export-configure.py {surge,hosts,merlin}

        HOSTS+=$(python export-configure.py hosts)"\n\n"

    fi
done

#####################################################################################
#####################################################################################

if [[ "$HOSTS" == "" ]]; then
    usage
fi

FILE="/tmp/refresh-hosts"

echo "$HOSTS" > "$FILE"
echo ">> Written to $FILE"

cat "$FILE" | pbcopy
echo ">> Copied!"

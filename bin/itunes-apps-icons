#!/bin/sh

# 抓取itunes下所有app的icon(1024尺寸)

INPUT_DIR="$HOME/Music/iTunes/iTunes Media/Mobile Applications"
OUTPUT_DIR="$HOME/Pictures/Resources/iTunes Apps Icons"

if ! [ -d "$INPUT_DIR" ]; then
        echo "\"$INPUT_DIR\" does not exist." >&2
        exit 1
fi

mkdir -p "$OUTPUT_DIR"

cd "$INPUT_DIR"

for f in *.ipa; do
    ipaFile="$INPUT_DIR/$f"
    oFileName=$(echo "$f" | sed -e 's/[ ][0-9].*\.ipa//')
    oFile="$OUTPUT_DIR/${oFileName}"

    # handle unzip error: http://stackoverflow.com/a/16919522/521946
    if ! unzip -p "$ipaFile" "iTunesArtwork" &> "$oFile"; then
        echo ">> There is no iTunesArtwork in $f"
        continue
    fi

    format=$(sips -g format "$oFile" | tail -n1 | cut -d" " -f4)
    if [[ "$format" == "jpeg" ]]; then
        format="jpg"
    fi

    outputFile="${oFile}.${format}"
    mv "$oFile" "$outputFile"

    if [ "$format" == "png" ]; then
        # echo "$outputFile"
        tmpFile="$outputFile.tmp"
        /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/pngcrush -revert-iphone-optimizations -q "$outputFile" "$tmpFile" 2>/dev/null
        mv "$tmpFile" "$outputFile"
    fi

done

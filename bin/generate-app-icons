#!/bin/sh

# 从1024的png图片生成各个尺寸的图标

# 生成尺寸, 可选参数 #nofile, @2x, @3x, #ipad
# see: https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/MobileHIG/IconMatrix.html
# iOS 5,6+
SIZES=( 57 57@2x 60@2x 60@3x 72#ipad 72@2x#ipad 76#ipad 76@2x#ipad )
SIZES+=( 29#nofile 29@2x#nofile 40@2x#nofile )
SIZES+=( 29#ipad#nofile 29@2x#ipad#nofile 40#ipad#nofile 40@2x#ipad#nofile 50#ipad#nofile 50@2x#ipad#nofile )

# 额外生成的尺寸，用于上传各个市场或开放平台
OTHER_SIZES=( 16 28 32 50 60 80 108 120 180 200 300 512 1024 )

if [ "$#" -ne 1 ]; then
    this=$(basename "$0")
    echo "Usage: $this path/to/icon-1024.png"
    exit 1
fi

INPUT_FILE=$1

if ! [[ -f "$INPUT_FILE" ]]; then
    echo "\"$INPUT_FILE\" does not exist."
    exit 1
fi

OUTPUT_DIR=$(dirname "$INPUT_FILE")
OUTPUT_DIR="${OUTPUT_DIR}/$(date +"%Y%m%d-%H%M%S")-$RANDOM"
ICONSET_DIR="${OUTPUT_DIR}/AppIcon.appiconset"
IMAGES_JSON=""

mkdir -p "$OUTPUT_DIR"
mkdir -p "$ICONSET_DIR"

for item in "${SIZES[@]}"; do
    idiom="iphone"
    scale="1x"
    sizeBase=""
    size=""
    filename=""
    sizeReal=""

    if [[ "$item" =~ ([0-9]+) ]]; then
        sizeBase=${BASH_REMATCH[1]}
        sizeReal=$sizeBase
        size="${sizeBase}x${sizeBase}"
    else
        continue
    fi

    if [[ $item =~ "#ipad" ]]; then
        idiom="ipad"
    fi

    if [[ $item =~ "@2x" ]]; then
        scale="2x"
        sizeReal=$(( $sizeReal * 2))
    elif [[ $item =~ "@3x" ]]; then
        scale="3x"
        sizeReal=$(( $sizeReal * 3))
    fi

    if ! [[ $item =~ "#nofile" ]]; then
        filename="AppIcon${size}"
        if ! [[ $scale == "1x" ]]; then
            filename="${filename}@${scale}"
        fi
        if [[ $idiom == "ipad" ]]; then
            filename="${filename}~ipad"
        fi
        filename="${filename}.png"
    fi

    # echo "$item $idiom $scale $size $sizeReal $filename"

    if ! [[ $filename == "" ]]; then
        # echo '' 2>/dev/null
        # sips -Z $sizeReal "$INPUT_FILE" --out "$ICONSET_DIR/$filename" 2>/dev/null
        echo "$ICONSET_DIR/$filename"
        convert "$INPUT_FILE" -resize $sizeReal "$ICONSET_DIR/$filename"
    fi

    IMAGES_JSON="${IMAGES_JSON}\t\t{\n"
    IMAGES_JSON="${IMAGES_JSON}\t\t\t\"idiom\" : \"${idiom}\",\n"
    IMAGES_JSON="${IMAGES_JSON}\t\t\t\"size\" : \"${size}\",\n"
    if ! [[ $filename == "" ]]; then
        IMAGES_JSON="${IMAGES_JSON}\t\t\t\"filename\" : \"${filename}\",\n"
    fi
    IMAGES_JSON="${IMAGES_JSON}\t\t\t\"scale\" : \"${scale}\"\n"
    IMAGES_JSON="${IMAGES_JSON}\t\t},\n"

done

# 去除末尾最后一个逗号
IMAGES_JSON="${IMAGES_JSON%???}"
IMAGES_JSON="${IMAGES_JSON}\n"

JSON_images="\t\"images\" : [\n${IMAGES_JSON}\t],\n"
JSON_info="\t\"info\" : {\n\t\t\"version\" : 1,\n\t\t\"author\" : \"0x123.com\"\n\t},\n"
JSON_properties="\t\"properties\" : {\n\t\t\"pre-rendered\" : true\n\t}\n"
JSON="{\n${JSON_images}${JSON_info}${JSON_properties}}"
echo $JSON > "${ICONSET_DIR}/Contents.json" 2>/dev/null


# other size
for size in "${OTHER_SIZES[@]}"; do
    # sips -Z $size "$INPUT_FILE" --out "$OUTPUT_DIR/Icon-$size.png" 2>/dev/null
    echo "$OUTPUT_DIR/Icon-$size.png"
    convert "$INPUT_FILE" -resize $size "$OUTPUT_DIR/Icon-$size.png"
done

# favicon.ico for website
# https://gist.github.com/pfig/1808188#gistcomment-938494
convert "$INPUT_FILE"  -bordercolor white -border 0 \
    \( -clone 0 -resize 16x16 \) \
    \( -clone 0 -resize 32x32 \) \
    \( -clone 0 -resize 48x48 \) \
    \( -clone 0 -resize 64x64 \) \
    -delete 0 -alpha off -colors 256 "$OUTPUT_DIR/favicon.ico"
echo "$OUTPUT_DIR/favicon.ico"

echo "\nOutput: $OUTPUT_DIR"
open "$OUTPUT_DIR"
